---
title: gitops介绍与实现
date: 2019-10-31 12:12:28
tags:
- devops
---

# gitops介绍

gitops就是git是一个状态的存储器，所有的操作都要从git里面输入，git保存了我们系统状态的期望数据。

通过控制器来对系统实际状态和期望状态进行调协

<!--more-->

# 不可变基础设施

任何基础设施的实例（包括服务器、容器等各种软硬件）一旦创建之后便成为一种只读状态，不可对其进行任何更改。如果需要修改或升级某些实例，唯一的方式就是创建一批新的实例以替换。这种思想与不可变对象的概念是完全相同的。

# 基本原则

- 任何能够被描述的内容都必须存储在Git库中
通过使用Git作为存储声明性基础架构和应用程序代码的存储仓库，可以方便地监控集群，以及检查比较实际环境的状态与代码库上的状态是否一致。所以，我们的目标是描述系统相关的所有内容：策略，代码，配置，甚至监控事件和版本控制等，并且将这些内容全部存储在版本库中，在通过版本库中的内容构建系统的基础架构或者应用程序的时候，如果没有成功，则可以迅速的回滚，并且重新来过。
- 不应直接使用Kubectl
作为一般规则，不提倡在命令行中直接使用kubectl命令操作执行部署基础架构或应用程序到集群中。还有一些开发者使用CI工具驱动应用程序的部署，但如果这样做，可能会给生产环境带来潜在不可预测的风险。  
- 调用Kubernetes 的API的接口或者控制器应该遵循 Operator 模式
调用Kubernetes 的API的接口或者控制器应该遵循 Operator 模式（什么是Operator 模式？），集群的状态和Git库中的配置文件等要保持一致，并且查看分析它们之间的状态差异。

# 流水线

![gitops](https://qiniu.li-rui.top/gitops.png)

更新镜像的步骤也可以在ci中进行，只是就会将一些凭据放到ci流程中

# 循环

![sync](https://qiniu.li-rui.top/sync.png)

可观察性和git是两个真实性的来源

# gitops来的好处

- 更加快速地开发
借助GitOps的最佳实践，开发人员可以使用熟悉的Git工具，便捷地将应用程序和其对应的配置文件集持续部署到Kubernetes等云原生环境，提高业务的敏捷度，快速地相应用户的需求，有助于增加企业市场的竞争力。
- 更好地进行运维
借助GitOps，可以实现一个完整的端到端的交付流水线。不仅可以实现拉式的持续集成流水线和持续部署流水线，而且系统的运维操作可以通过Git来完成。
- 更强大的安全保证
几乎所有的Git库都提供角色和权限控制，与开发和运维无关的人员没有权限操作Git库。而不是直接把服务器或者集群的操作权限散发出去，这样特别容易引起安全泄露。
- 更容易合规的审计
由于以安全的方式跟踪和记录更改，因此合规性和审计变得微不足道。使用Diffs等比较工具还可以将集群状态的可信定义与实际运行的集群进行比较，从而确保跟踪和可审计的更改与实际情况相符。

# 相关实现

- [flux](https://github.com/fluxcd/flux)
- [argocd](https://github.com/argoproj/argo-cd)

# 参考资料

```bash
https://cloud.tencent.com/developer/article/1358628
https://juejin.im/post/5b8277b3e51d4538b406d573
```
